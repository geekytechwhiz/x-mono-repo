name: test-nx
on:
  push:
    branches:
      - develop_x
      - dev_nx-cloud
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  authoring-ui:
    name: authoring-ui-test-nx
    runs-on: ubuntu-16core-64GB
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set env vars(develop)
        if: endsWith(github.ref, '/develop')
        run: |
          echo "PROJECT_ID=PROJECT_ID_$(echo ${{github.ref_name}} | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV

      # - name: Setup Node.js
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: "18.x"

      # - name: Restore cached npm dependencies
      #   id: cache-dependencies-restore
      #   uses: actions/cache@v3
      #   with:
      #     path: |
      #       node_modules
      #     key: npm-dependencies-${{ hashFiles('package-lock.json') }}

      # - name: Start CI run
      #   run: 'npx nx-cloud start-ci-run --distribute-on="8 linux-medium-js"'

      - name: Install Dependencies
        run: npm i --legacy-peer-deps

      # - name: Setup Nx Cloud
      #   run: npx nx connect --organization=hcl-x --token ${{ secrets.NX_CLOUD_TOKEN }}
      #   env:
      #     gh_token: ${{ secrets.gh_token }}
      # - uses: nrwl/nx-set-shas@v3
      #   with:
      #     main-branch-name: develop
      # - name: Record Nx Cloud Actions and Execute Nx Commands
      #   run: npx nx affected --target=build --parallel --base=origin/develop --head=HEAD --apps=authoring-web
      - uses: nrwl/nx-set-shas@v3
        # This line is needed for nx affected to work when CI is running on a PR
        # with:
        #   main-branch-name: develop
      - run: git branch --track main origin/develop
      - run: npx nx affected -t build --parallel=3

      #DEPLOY START
